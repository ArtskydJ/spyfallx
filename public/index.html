<!DOCTYPE html>
<html>
	<head>
		<title>
			Spyfall X
		</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="/styles/variables.css">

		<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
		<link rel="manifest" href="/icons/site.webmanifest">
		<link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5">
		<link rel="shortcut icon" href="/icons/favicon.ico">
		<meta name="msapplication-TileColor" content="#ffc40d">
		<meta name="msapplication-config" content="/icons/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">

	</head>
	<body data-username-filled=false data-error=false>
		<h1>Spyfall X</h1>

		<hr>

		<div class="form">
			<label>
				<span class=label-text>
					Your name:
				</span>
				<input type="text" placeholder="Your Cool Name Here" id="player-name">
			</label>

			<div class="center-row">
				<button type=button id=create-new-game>Create new game</button>
			</div>

			<label>
				<span class="label-text">
					Join existing game:
				</span>
				<input type="text" placeholder="game code" id=game-id>
			</label>

			<div class="center-row">
				<button type=button id=join-game>Join game</button>
			</div>
		</div>

		<div id=error-message data-when=error class="center">

		</div>

		<style>
			[data-username-filled=false] #create-new-game {
				disabled: true;
			}

			.form {
				display: flex;
				flex-direction: column;
				align-items: stretch;
				justify-content: space-around;
			}

			.form > * {
				margin-bottom: 16px;
			}

			.center-row {
				display: flex;
				justify-content: center;
				align-items: stretch;
			}

			hr {
				flex-grow: 1;
			}

			.form label {
				display: flex;
				flex-direction: column;
				align-items: stretch;
			}
			.form label input {
				flex-grow: 1;
			}

			.label-text {
				padding-top: 8px;
				padding-bottom: 8px;
			}

			.form button {
				flex-grow: 1;
				max-width: 400px;
			}





			[data-when] {
				display: none;
			}

			[data-error=true] [data-when=error] {
				display: block;
			}

		</style>


		<script type=module>
			import { post } from './futch.js'
			import { PLAYER_NAME_KEY } from './constants.js'
			import getPlayerDeetz from './get-player-deetz.js'

			const body = document.body

			const CREATE_NEW_GAME_BUTTON_ID = `create-new-game`
			const JOIN_GAME_BUTTON_ID = `join-game`
			const NAME_INPUT_ID = `player-name`
			const GAME_ID_INPUT_ID = `game-id`

			const playerNameElement = document.getElementById(NAME_INPUT_ID)

			const handle500 = async promise => {
				try {
					return await promise
				} catch (err) {
					console.log(err)
					err.json().then(body => {
						document.getElementById(`error-message`).innerText = body.message || body
					})

					document.body.dataset.error = true

					throw err
				}
			}
			const postWithErrorHandling = (...args) => handle500(post(...args))

			const on = (id, event, fn) => {
				const e = document.getElementById(id)
				e.addEventListener(event, fn)
				return () => e.removeEventListener(event, fn)
			}

			const init = async() => {
				const initialPlayerName = localStorage.getItem(PLAYER_NAME_KEY)

				const updateUsernameFilled = () => {
					body.dataset.dataUsernameFilled = !!playerNameElement.value
				}

				if (initialPlayerName) {
					console.log(`Found saved player name`, initialPlayerName)
					playerNameElement.value = initialPlayerName
					updateUsernameFilled()
				}
				playerNameElement.addEventListener(`input`, updateUsernameFilled)

				window.addEventListener(`unhandledrejection`, event => {
					console.error(event.reason)
				})
			}

			const playerDeetzPromise = handle500(getPlayerDeetz())


			const createGameId = async() => {
				const { gameId } = await postWithErrorHandling(`/api/create`)

				return gameId
			}

			const setNameAndNavigateToGame = async({ gameId }) => {
				const { playerSecret } = await playerDeetzPromise

				console.log(`setting name to`, playerNameElement.value)

				localStorage.setItem(PLAYER_NAME_KEY, playerNameElement.value)

				await postWithErrorHandling(`/api/set-name`, {
					name: playerNameElement.value,
					playerSecret,
				})

				document.location = `game.html?gameId=${ gameId }`
			}

			on(CREATE_NEW_GAME_BUTTON_ID, `click`, async() => {
				await setNameAndNavigateToGame({
					gameId: await createGameId(),
				})
			})

			on(JOIN_GAME_BUTTON_ID, `click`, async() => {
				const gameId = document.getElementById(GAME_ID_INPUT_ID).value

				await setNameAndNavigateToGame({
					gameId,
				})
			})

			init()
		</script>

		<link rel="stylesheet" href="/styles/basic.css">
	</body>
</html>
