<!DOCTYPE html>
<html>
	<head>
		<title>
			Spyfall X
		</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body data-username-filled=false>
		<h1>Spyfall X</h1>

		<hr>
		<label>
			Your name:
			<input type="text" placeholder="Joe Internet" id="player-name">
		</label>

		<button onclick=createAndNavigate() id=create-new-game>Create new game</button>

		<label>
			Game id:
			<input type="text" placeholder="abefi">
		</label>

		<button>Join game</button>

		<style>
			[data-username-filled=false] #create-new-game {
				disabled: true;
			}
		</style>


		<script>
			const PLAYER_SECRET_KEY = `playerSecret`
			const PLAYER_NAME_KEY = `playerName`
			const body = document.body

			// should probably be able to create a player without a name
			// only need to assign a name to the player before joining the game

			const initialPlayerName = localStorage.getItem(PLAYER_NAME_KEY)

			const playerNameElement = document.getElementById(`player-name`)

			const updateUsernameFilled = () => {
				body.dataset.dataUsernameFilled = !!playerNameElement.value
			}

			if (initialPlayerName) {
				playerNameElement.value = initialPlayerName
				updateUsernameFilled()
			}
			playerNameElement.addEventListener(`keyup`, updateUsernameFilled)

			const post = (url, body) => fetch(url, { method: `POST`, body })

			const createPlayer = async name => {
				const { playerId, playerSecret } = await post(`/api/create-player`, {
					name,
				})

				if (!playerSecret || !playerId) {
					throw new Error(`Didn't get player secret or id back from server.  id: ${ playerId }, secret: ${ playerSecret } }`)
				}

				localStorage.setItem(PLAYER_SECRET_KEY, playerSecret)
				return { playerId, playerSecret }
			}

			const getPlayerDeetz = async() => {
				let playerSecret = localStorage.getItem(PLAYER_SECRET_KEY)

				if (playerSecret) {
					console.log(`found player secret`, playerSecret)
					const { authed, playerId } = await fetch(`api/player-id/${ playerSecret }`)
					if (authed) {
						return {
							playerId,
							playerSecret,
						}
					}
				}

				const newPlayer = await createPlayer()
				const { playerId } = newPlayer
				playerSecret = newPlayer.playerSecret

				return {
					playerId,
					playerSecret,
				}
			}

			const playerDeetzPromise = getPlayerDeetz()


			const createGameId = async() => {
				const response = await post(`/api/create`)

				const { gameId } = await response.json()

				return gameId
			}

			const createAndNavigate = async() => {
				const [
					{ playerId, playerSecret },
					gameId,
				] = await Promise.all([
					playerDeetzPromise,
					createGameId(),
				])

				await post(`/api/join-game`, {
					gameId,
					playerSecret,
				})

				document.location = `game.html?gameId=${ gameId }`
			}

			window.on(`unhandledrejection`, event => {
				console.error(event.reason)
			})
		</script>

		<link rel="stylesheet" href="/styles/basic.css">
	</body>
</html>
